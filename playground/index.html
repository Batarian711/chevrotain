<!DOCTYPE html>
<!--100vh needed for IE 11 (maybe others too) otherwise html.height will return 3 -->
<html style="height: 100vh">

<head lang="en">
    <link rel="icon"
          type="image/jpeg"
          href="../photos/chevrotain.jpg">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="CSS/playground.css">
    <link rel="stylesheet" type="text/css" href="CSS/railroad-diagrams.css">
    <link rel="stylesheet" type="text/css" href="CSS/gh-fork-ribbon.css">
    <link rel="stylesheet" href="../bower_components/CodeMirror/lib/codemirror.css">

    <script>
        // expose the whole Chevrotain's API including the 'private' parts to allow cleaning the the cache.
        window.CHEV_TEST_MODE = true
    </script>
    <script src="../bower_components/lodash/lodash.js"></script>
    <script src="../bower_components/jquery/dist/jquery.js"></script>
    <script src="libs/jquery.svg.js"></script>
    <script src="libs/jquery.svgdom.js"></script>
    <script src="../bower_components/chevrotain/release/chevrotain.js"></script>
    <script src="../bower_components/CodeMirror/lib/codemirror.js"></script>
    <script src="../bower_components/CodeMirror/mode/javascript/javascript.js"></script>
    <script src="RailRoadDiagreams/railroad-diagrams.js"></script>
    <script src="editors.js"></script>
    <script src="errorMarkers.js"></script>
    <script src="examples.js"></script>
    <script src="syntaxBuilding.js"></script>
    <script src="diagramsHighlights.js"></script>
    <title>Playground</title>
</head>
<body style="background-color: #f1f1f1; margin-left: 0.7vh; margin-right:0.7vh">

<div class="github-fork-ribbon-wrapper right">
    <div class="github-fork-ribbon ">
        <a href="https://github.com/sap/chevrotain">Fork me on GitHub</a>
    </div>
</div>

<div id="left" class="sideEditor leftSide">
    <div id="impel" class="card" style="width: 100%; overflow:hidden; height: 76vh">
        <div class="boxHeader">
            <h1>Parser</h1>

            <div style="float: right;">
                <h3 style="float: left;">Example:</h3>
                <label for="example-choice"></label>
                <select id="example-choice" class="select"></select>
            </div>
        </div>
        <label for="parserImplementationEditor"></label>
        <textarea id="parserImplementationEditor"></textarea>
    </div>

    <div class="horizontalSeparator"
         onmousedown="startVerticalLeft(event)">
        <i class="fa fa-ellipsis-h horizontalDragHandle"> </i>
    </div>

    <div id="input" class="card" style="width: 100%; overflow: hidden; height: 21vh">
        <div class="boxHeader">
            <h1>Input</h1>

            <div style="float: right">
                <h3 style="float: left">Sample:</h3>
                <label for="samples-choice"></label>
                <select id="samples-choice" class="select"></select>
            </div>
        </div>
        <label for="parserInputEditor"></label>
        <textarea id="parserInputEditor"></textarea>
    </div>
</div>

<div class="verticalSeparator" onmousedown="startResizeHorizontal(event)">
    <i class="fa fa-ellipsis-v verticalDragHandle"> </i>
</div>

<div id="right" class="sideEditor rightSide">

    <div id="diagramsRoot" class="card" align="center" style="width: 100%; height:76vh; overflow: hidden">
        <div class="boxHeader">
            <h1>Syntax Diagrams</h1>
        </div>
        <div id="diagramsDiv" class="diagramsDiv" style="overflow: auto; height: 71.3vh"></div>
    </div>

    <div id="rightHorizontalSeparator" class="horizontalSeparator" onmousedown="startVerticalRight(event)">
        <i class="fa fa-ellipsis-h horizontalDragHandle"> </i>
    </div>

    <div id="output" class="card" style="width: 100%; overflow: hidden; height: 21vh">
        <div class="boxHeader">
            <h1>Output</h1>
        </div>
        <label for="parserOutput"></label>
        <textarea id="parserOutput"></textarea>
    </div>
</div>

<script>

    var inResizeHorizontalMode = false
    var inResizeVerticalLeft = false
    var inResizeVerticalRight = false
    // TODO: get from css?
    var PAGE_VH = 97
    var H_SEPARATOR_VH = 1.12


    function modifyCursor(cursorKeyword) {
        document.body.style.cursor = cursorKeyword
    }

    function revertToOriginalCursor() {
        document.body.style.cursor = "auto"
    }

    function startResizeHorizontal(event) {
        event.preventDefault()
        modifyCursor("col-resize")
        inResizeHorizontalMode = true
    }

    function startVerticalLeft(event) {
        event.preventDefault()
        modifyCursor("row-resize")
        inResizeVerticalLeft = true
    }

    function startVerticalRight(event) {
        event.preventDefault()
        modifyCursor("resizeRow")
        inResizeVerticalRight = true
    }

    function endResize() {
        revertToOriginalCursor()
        inResizeHorizontalMode = false
        inResizeVerticalLeft = false
        inResizeVerticalRight = false
        refreshCodeMirrorInstances()
    }

    function resizeRoot(event) {
        if (inResizeHorizontalMode) {
            resizeHorz(event)
        }
        else if (inResizeVerticalLeft) {
            resizeVerticalLeft(event)
        }
        else if (inResizeVerticalRight) {
            resizeVerticalRight(event)
        }

    }

    // TODO: move to layout.js
    var resizeHorz = _.throttle(dragMiddleHorz, 20)
    function dragMiddleHorz(event) {
        event.preventDefault()

        var eventX = event.clientX
        var htmlWidth = $("html").width()
        // TODO: more magic numbers!
        var percentageLeft = (eventX / htmlWidth) * 99.3
        if (percentageLeft) {
            percentageLeft = percentageLeft < 1 ? 0 : percentageLeft
            percentageLeft = percentageLeft > 98.26 ? 99.26 : percentageLeft
            var leftFinal = percentageLeft + "%"
            $("#left").width(leftFinal)
            // magical number! TODO: get this from CSS
            var rightFinal = "" + (99.26 - percentageLeft) + "%"
            $("#right").width(rightFinal)
        }
    }

    var resizeVerticalLeft = _.throttle(_.partialRight(dragVertical, "impel", "input"), 20)
    var resizeVerticalRight = _.throttle(_.partialRight(dragVertical, "diagramsRoot", "output"), 20)

    function dragVertical(event, topID, buttomID) {
        event.preventDefault()

        var eventY = event.clientY
        var htmlHeight = $("html").height()
        var percentageTop = (eventY / htmlHeight) * PAGE_VH

        if (percentageTop) {
            percentageTop = percentageTop < 1 ? 0 : percentageTop
            percentageTop = percentageTop > PAGE_VH - 1 ? PAGE_VH : percentageTop
            var topFinal = percentageTop + "vh"
            $("#" + topID).height(topFinal)
            var buttomFinal = "" + (PAGE_VH - percentageTop) + "vh"
            $("#" + buttomID).height(buttomFinal)
        }
    }

    function refreshCodeMirrorInstances() {
        javaScriptEditor.refresh()
        inputEditor.refresh()
        parserOutput.refresh()
    }

    // TODO: different tick time according to browser... firefox seems slow... :(
    var tickSize = 2;
    var tickTime = 4;
    var areDiagramsHidden = false
    var lastOutputDivPercentage
    var lastOutputDivPixels
    var lastDiagramsDivPixels

    function hideDiagrams() {
        if (areDiagramsHidden) {
            return
        }
        areDiagramsHidden = true
        var htmlHeight = $("html").height()

        $("#rightHorizontalSeparator").css("visibility", "hidden")

        lastOutputDivPixels = $("#output").height()
        lastDiagramsDivPixels = $("#diagramsRoot").height()
        lastOutputDivPercentage = lastOutputDivPixels / htmlHeight * 100
        var currDiagramsDivPercentage = PAGE_VH - lastOutputDivPercentage
        function resizeTick() {
            setTimeout(function () {
                if (currDiagramsDivPercentage > 0) {
                    var outputVh = "" + (PAGE_VH - currDiagramsDivPercentage + tickSize) + "vh"
                    var diagramsVh = currDiagramsDivPercentage - tickSize + "vh"
                    $("#output").height(outputVh)
                    $("#diagramsRoot").height(diagramsVh)
                    currDiagramsDivPercentage -= tickSize
                    resizeTick()
                }
                else {
                    $("#output").height(PAGE_VH + H_SEPARATOR_VH + "vh")
                    $("#diagramsRoot").height("0vh")
                    refreshCodeMirrorInstances()
                    $("#rightHorizontalSeparator").css("display", "none")
                }
            }, tickTime)
        }

        resizeTick()
    }

    function showDiagrams() {
        // always need to re-enable the separator
        $("#rightHorizontalSeparator").css("display", "block");
        $("#rightHorizontalSeparator").css("visibility", "visible")

        if (!areDiagramsHidden) {
            return
        }
        areDiagramsHidden = false

        var tickSize = 1;
        var tickTime = 4;

        var currOutputDivPercentage = PAGE_VH

        function resizeTick() {
            setTimeout(function () {
                if (currOutputDivPercentage > lastOutputDivPercentage) {

                    // last tick, must be precise
                    if ((currOutputDivPercentage - tickSize) < lastOutputDivPercentage) {
                        var viewportHeight = $(window).height();
                        var lastOutputDivVh = lastOutputDivPixels / viewportHeight * 100;
                        var lasDiagramsDivVh = lastDiagramsDivPixels / viewportHeight * 100;

                        // both VH together must equal PAGE_VH
                        var offset = lastOutputDivVh + lasDiagramsDivVh - PAGE_VH
                        // assumes offset is positive, TODO: is this assumption safe? ???
                        lastOutputDivVh = lastOutputDivVh - (offset / 2)
                        lasDiagramsDivVh = lasDiagramsDivVh - (offset / 2)

                        $("#diagramsRoot").height(lasDiagramsDivVh.toFixed(2) + "vh")
                        $("#output").height(lastOutputDivVh.toFixed(2) + "vh")
                    }
                    else {
                        var diagramsVh = "" + (PAGE_VH - currOutputDivPercentage + tickSize) + "vh"
                        var outputVh = currOutputDivPercentage - tickSize + "vh"

                        $("#output").height(outputVh)
                        $("#diagramsRoot").height(diagramsVh)
                    }

                    currOutputDivPercentage -= tickSize
                    resizeTick()
                }
                else {
                    refreshCodeMirrorInstances()
                }
            }, tickTime)
        }

        resizeTick()
    }

    // global state
    var lexer = null
    var parser = null
    var defaultRuleName = null
    var javaScriptEditor = null
    var inputEditor = null
    var inputEditorMarkers = []
    var lexerErrorsMarkers = []
    var parserErrorsMarkers = []
    var examplesDropdown = null
    var samplesDropdown = null
    var parserOutput = null
    var diagramsDiv = null

    $(document).ready(function init() {
        // defer error handling so we can display error markers visually
        // instead of using the default chevrotain behavior of throwing exceptions.
        chevrotain.Parser.DEFER_DEFINITION_ERRORS_HANDLING = true

        // init global state
        examplesDropdown = $("#example-choice")
        samplesDropdown = $("#samples-choice")
        diagramsDiv = _.first($("#diagramsDiv"))

        var implTextArea = $("#parserImplementationEditor")
        javaScriptEditor = CodeMirror.fromTextArea(_.first(implTextArea), {
            lineNumbers   : true,
            viewportMargin: Infinity
        })

        javaScriptEditor.on("change", _.debounce(onImplementationEditorContentChange, 250))

        inputEditor = CodeMirror.fromTextArea(_.first($("#parserInputEditor")), {
            lineNumbers   : true,
            viewportMargin: Infinity
        })

        inputEditor.on("change", _.debounce(onInputEditorContentChange, 250))

        parserOutput = CodeMirror.fromTextArea(_.first($("#parserOutput")), {
            lineNumbers   : true,
            viewportMargin: Infinity,
            readOnly      : true
        })

        initExamplesDropDown(examplesDropdown)
        examplesDropdown.change(function () {
            loadExample(examplesDropdown.val())
        })

        loadExample("json", true)
        updateSamplesDropDown()

        samplesDropdown.change(function () {
            loadSamples(samplesDropdown.val())
        })

        javaScriptEditor.setSize("100%", "100%")
        // the input bottom area editors may have issues when Codemirror tries to resize to add a scroll bar
        // causing the headers to disappear. 80% seems to resolve this issue in common use cases.
        inputEditor.setSize("100%", "80%")
        parserOutput.setSize("100%", "100%")

        $(document).mouseup(endResize)
        $(document).mousemove(resizeRoot)
    })
</script>

</body>
</html>


<!DOCTYPE html>
<html>
<head lang="en">
    <link rel="icon"
          type="image/jpeg"
          href="../photos/chevrotain.jpg">
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="CSS/playground.css">
    <link rel="stylesheet" type="text/css" href="CSS/railroad-diagrams.css">
    <link rel="stylesheet" href="../bower_components/CodeMirror/lib/codemirror.css">

    <script>
        // expose the whole Chevrotain's API including the 'private' parts to allow cleaning the the cache.
        window.CHEV_TEST_MODE = true
    </script>
    <script src="../bower_components/jquery/dist/jquery.js"></script>
    <script src="../bower_components/lodash/lodash.js"></script>
    <script src="../bower_components/chevrotain/release/chevrotain.js"></script>
    <script src="../bower_components/CodeMirror/lib/codemirror.js"></script>
    <script src="../bower_components/CodeMirror/mode/javascript/javascript.js"></script>
    <script src="RailRoadDiagreams/railroad-diagrams.js"></script>
    <script src="errorMarkers.js"></script>
    <script src="examples.js"></script>
    <script src="syntaxBuilding.js"></script>
    <title>Playground</title>
</head>
<body style="background-color: #f1f1f1">

<div align="center">
    <div class="leftPart">
        <div class="card">

            <div align="center">
                <h1 style="float: left;">Implement Parser</h1>

                <div style="float: right; margin-top: 7px;">
                    <h3 style="float: left; margin-top: 4px">Example:</h3>
                    <label for="example-choice"></label><select id="example-choice"
                                                                style="float: left; margin-left: 8px; margin-right: 8px; margin-top: 2px;"></select>
                </div>
                <div style="clear:both;"></div>
                <hr class="hrInCardHeader">
                <div id="errorMessagesDiv"></div>
            </div>

            <div class="textareawrapper">
                <label for="parserImplementationEditor"></label>
                <textarea id="parserImplementationEditor"></textarea>
            </div>
        </div>

        <div align="center" class="card">
            <h1 style="float: left">Input</h1>

            <div style="float: right; margin-top: 7px;">
                <h3 style="float: left; margin-top: 4px">Sample:</h3>
                <label for="samples-choice"></label><select id="samples-choice"
                                                            style="float: left; margin-left: 8px; margin-right: 8px; margin-top: 2px;"></select>
            </div>
            <div style="clear:both;"></div>
            <hr class="hrInCardHeader">
            <div class="textareawrapper">
                <label for="parserInput"></label><textarea id="parserInput" class="textArea" rows="6" cols="100"
                                                           spellcheck="false"></textarea>
            </div>
        </div>


    </div>
    <div class="rightPart">
        <div class="card">
            <div align="center">
                <h1 style="float: left">Syntax Diagrams</h1>
                <label class="checkboxLabel"><input type='checkbox' id="chooseTerminalPrintStyle" onclick='checkboxChanged(this)'>Show
                    Terminal's RegExp</label>
            </div>
            <div style="clear:both;"></div>
            <hr class="hrInCardHeader">
            <div id="svgWrapper" class="svgWrapper"></div>
        </div>
        <div class="card">
            <h1 style="float: left">Output</h1>

            <div style="clear:both;"></div>
            <hr class="hrInCardHeader">
            <div class="textareawrapper">
                <label for="parserOutput"></label><textarea id="parserOutput" class="textArea" rows="10" cols="100" spellcheck="false"
                                                            readonly></textarea>
            </div>
        </div>
    </div>
    <div style="clear:both;"></div>
</div>


<script>
    var lexer = null
    var parser = null
    var defaultRuleName = null
    var javaScriptEditor = null
    var inputEditor = null
    var inputEditorMarkers = []
    var lexerErrorsMarkers = []
    var parserErrorsMarkers = []

    function lexAndParse(text, lexer, parser, startRuleName) {
        var lexResult = lexer.tokenize(text)
        parser.reset()
        parser.input = lexResult.tokens
        var value = parser[startRuleName]()
        return {value: value, lexErrors: lexResult.errors, parseErrors: parser.errors}
    }

    function cleanChevrotainCache() {
        var hashmaps = _.filter(chevrotain.cache, function (prop) {
            return prop instanceof chevrotain.lang.HashTable
        })

        _.forEach(hashmaps, function (cacheMap) {
            cacheMap._state = {}
        })
    }

    function renderSyntaxDiagrams(topRules, useTokenNames) {
        //TODO Use jQuery
        var svgWrapperDiv = document.getElementById("svgWrapper")
        svgWrapperDiv.innerHTML = ""
        _.forEach(topRules, function (production) {
            var currDiagramHtml = convertProductionToDiagram(production, useTokenNames)
            document.getElementById("svgWrapper").innerHTML += '<h2 class="diagramHeader">' + production.name + ':</h2>' + currDiagramHtml
        })
    }

    function editorContentsChanged() {
        cleanChevrotainCache()
        var editorFuncVal = eval(javaScriptEditor.getValue())
        var parserConstructor = editorFuncVal.parser
        lexer = editorFuncVal.lexer
        markLexerDefinitionErrors(lexer)


        defaultRuleName = editorFuncVal.defaultRule
        var errMsgDiv = $("#errorMessagesDiv")
        errMsgDiv.empty()
        parser = new parserConstructor()
        markParserDefinitionErrors(parser)
        var topRules = parser.getGAstProductions().values()
        renderSyntaxDiagrams(topRules, !$("#chooseTerminalPrintStyle").is(':checked'))
    }

    function checkboxChanged(cb) {
        var state = !cb.checked
        var topRules = parser.getGAstProductions().values()
        renderSyntaxDiagrams(topRules, state)
    }

    function initExamplesDropDown() {
        var examplesDropdown = $("#example-choice")
        examplesDropdown.find("option").remove()
        _.forEach(_.keys(samples), function (sampleName) {
            examplesDropdown.append("<option>" + sampleName + "</option>")
        })
    }

    function loadExample(exampleName, firstTime) {
        var samplesDropdown = $("#samples-choice")
        var sample = samples[exampleName]
        // reduce whitespace used for Indentation, 2 spaces is also used in the code mirror editor
        var sampleText = "(" + sample.implementation.toString().replace(/    /g, "  ") + "())"

        javaScriptEditor.setValue(sampleText)
        updateSamplesDropDown()
        if (firstTime) {
            editorContentsChanged() // can't wait for debounce on the first load as loadSamples will trigger lexAndParse
        }
        loadSamples(samplesDropdown.val())
    }

    function loadSamples(exampleName) {
        var examplesDropdown = $("#example-choice")
        inputEditor.setValue(samples[examplesDropdown.val()].sampleInputs[exampleName])
        $("#parserOutput").val("")
    }

    function parseInputAndDisplayResult() {
        var parserOutput = $("#parserOutput")
        parserOutput.val("")
        var result = lexAndParse(inputEditor.getValue(), lexer, parser, defaultRuleName)
        markInputErrors(result.lexErrors, result.parseErrors)
        var resultValue = result.value
        var processedResult
        if (_.isNumber(resultValue) || _.isString(resultValue) || _.isBoolean(resultValue)) {
            processedResult = resultValue // no processing needed
        }
        else if (_.isObject(resultValue)) {
            processedResult = JSON.stringify(resultValue, null, "\t") // TODO: any better way to display json?
        }
        parserOutput.val(processedResult)
    }

    function markInputErrors(lexErrors, parseErrors) {
        var start, end, marker
        _.forEach(inputEditorMarkers, function (currMarker) {
            currMarker.clear()
        })
        inputEditorMarkers = []

        _.forEach(lexErrors, function (currLexError) {
            start = {line: currLexError.line - 1, ch: currLexError.column - 1}
            end = {line: currLexError.line - 1, ch: currLexError.column - 1 + currLexError.length}
            marker = inputEditor.markText(start, end, {
                className: "markTextError",
                title    : currLexError.message
            })
            inputEditorMarkers.push(marker)
        })

        _.forEach(parseErrors, function (currParserError) {
            start = {line: currParserError.token.startLine - 1, ch: currParserError.token.startColumn - 1}
            end = {line: currParserError.token.endLine - 1, ch: currParserError.token.endColumn}
            marker = inputEditor.markText(start, end, {
                className: "markTextError",
                title    : currParserError.message
            })
            inputEditorMarkers.push(marker)
        })
    }

    function markLexerDefinitionErrors(lexer) {
        var marker, errPositions
        _.forEach(lexerErrorsMarkers, function (currMarker) {
            currMarker.clear()
        })
        lexerErrorsMarkers = []

        // TODO: duplicate errors, mark all RegExp
        // invalid errors, mark extendToken or the invalid param
        // missing ? not sure need to be handled maybe mark the extend Token?
        _.forEach(lexer.lexerDefinitionErrors, function (currLexError) {
            errPositions = getLexerErrorStartStopPos(currLexError, javaScriptEditor.getValue(), javaScriptEditor)
            _.forEach(errPositions, function (currPos) {
                marker = javaScriptEditor.markText(currPos.start, currPos.end, {
                    className: "markTextError",
                    title    : currLexError.message
                })
                lexerErrorsMarkers.push(marker)
            })
        })
    }

    // TODO extract common logic with markLexerDefinitonErrors
    function markParserDefinitionErrors(parser) {
        var marker, errPositions
        _.forEach(parserErrorsMarkers, function (currMarker) {
            currMarker.clear()
        })
        parserErrorsMarkers = []

        _.forEach(parser.definitionErrors, function (currParserDefError) {
            errPositions = getParserErrorStartStopPos(currParserDefError, javaScriptEditor.getValue(), parser.getGAstProductions(), javaScriptEditor)
            _.forEach(errPositions, function (currPos) {
                marker = javaScriptEditor.markText(currPos.start, currPos.end, {
                    className: "markTextError",
                    title    : currParserDefError.message
                })
                parserErrorsMarkers.push(marker)
            })
        })
    }

    function updateSamplesDropDown() {
        var samplesDropdown = $("#samples-choice")
        var examplesDropdown = $("#example-choice")
        samplesDropdown.find("option").remove()
        _.forOwn(samples[examplesDropdown.val()].sampleInputs, function (exampleValue, exampleName) {
            samplesDropdown.append("<option>" + exampleName + "</option>")
        })
    }

    $(document).ready(function () {

        // defer error handling so we can display error markers visually
        // instead of using the default chevrotain behavior of throwing exceptions.
        chevrotain.Parser.DEFER_DEFINITION_ERRORS_HANDLING = true

        javaScriptEditor = CodeMirror.fromTextArea(document.getElementById("parserImplementationEditor"), {
            lineNumbers   : true,
            viewportMargin: 35
        })
        javaScriptEditor.setSize("100%", "33rem")
        javaScriptEditor.on("change", _.debounce(editorContentsChanged, 250))

        inputEditor = CodeMirror.fromTextArea(document.getElementById("parserInput"), {
            lineNumbers: true
        })
        inputEditor.setSize("100%", "100%") // 100% height to auto adjust to contents
        inputEditor.on("change", _.debounce(parseInputAndDisplayResult, 250))

        // Workaround... I don't know why the text is aligned center by default...
        $(".CodeMirror").css({"text-align": "left"})

        var examplesDropdown = $("#example-choice")
        initExamplesDropDown(examplesDropdown)
        examplesDropdown.change(function () {
            loadExample(examplesDropdown.val())
        })

        loadExample("json", true)
        updateSamplesDropDown()

        var samplesDropdown = $("#samples-choice")
        samplesDropdown.change(function () {
            loadSamples(samplesDropdown.val())
        })
    })
</script>

</body>
</html>

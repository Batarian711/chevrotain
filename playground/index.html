<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="CSS/playground.css">
    <link rel="stylesheet" type="text/css" href="CSS/railroad-diagrams.css">
    <link rel="stylesheet" href="../bower_components/CodeMirror/lib/codemirror.css">
    <!-- Libraries -->
    <script>
        // expose even the Chevrotain's 'private' API to allow cleaning the the cache.
        window.CHEV_TEST_MODE = true
    </script>
    <script src="../bower_components/jquery/dist/jquery.js"></script>
    <script src="../bower_components/lodash/lodash.js"></script>
    <script src="../bower_components/chevrotain/release/chevrotain.js"></script>
    <script src="../bower_components/CodeMirror/lib/codemirror.js"></script>
    <script src="../bower_components/CodeMirror/mode/javascript/javascript.js"></script>
    <script src="RailRoadDiagreams/railroad-diagrams.js"></script>
    <script src="samples.js"></script>
    <script src="syntaxBuilding.js"></script>
    <title>Playground</title>
</head>
<body style="background-color: #f1f1f1">

<div align="center">
    <div class="leftPart">
        <div class="card">

            <div align="center">
                <h1 style="float: left;">Implement your parser</h1>

                <div style="float: right; margin-top: 7px;">
                    <h3 style="float: left; margin-top: 4px">Eample:</h3>
                    <select id="example-choice"
                            style="float: left; margin-left: 8px; margin-right: 8px; margin-top: 2px;"></select>
                </div>
                <div style="clear:both;"></div>
                <hr class="hrInCardHeader">
                <div id="errorMessagesDiv"></div>
            </div>

            <div class="textareawrapper">
                <label for="parserCodeAreaID"></label>
                <textarea id="parserCodeAreaID"></textarea>
            </div>
        </div>

        <div align="center" class="card">
            <h1 style="float: left">Run Your Parser</h1>
            <button id="parseInputBtn" style="float: left;margin-top: 7px;margin-left: 12px;">Parse!</button>
            <div style="float: right; margin-top: 7px;">
                <h3 style="float: left; margin-top: 4px">Eample:</h3>
                <select id="parser-input-example-choice"
                        style="float: left; margin-left: 8px; margin-right: 8px; margin-top: 2px;"></select>
            </div>
            <div style="clear:both;"></div>
            <hr class="hrInCardHeader">
            <div class="textareawrapper">
                <textarea id="parserInput" class="textArea" rows="2" cols="100" spellcheck="false"></textarea>
            </div>
        </div>


    </div>
    <div class="rightPart">
        <div class="card">
            <div align="center">
                <h1 style="float: left">Inspect your grammar</h1>
                <button id="refreshSyntaxDiagrams" style="float: left;margin-top: 9px;margin-left: 12px;">Refresh</button>
                <label class="checkboxLabel"><input type='checkbox' id="chooseTerminalPrintStyle" onclick='checkboxChangeHandler(this)'>Show Terminal's RegExp</label>
            </div>
            <div style="clear:both;"></div>
            <hr class="hrInCardHeader">
            <div id="svgWrapperId" class="svgWrapper"></div>
        </div>
        <div class="card">
            <h1 style="float: left">Parser Output</h1>
            <div style="clear:both;"></div>
            <hr class="hrInCardHeader">
            <div class="textareawrapper">
                <textarea id="parserOutput" class="textArea" rows="10" cols="100" spellcheck="false"
                          readonly="true"></textarea>
            </div>
        </div>
    </div>
    <div style="clear:both;"></div>
</div>


<script>
    var lexer = null
    var parser = null
    var defaultRuleName = null
    var editor = null

    function lexAndParse(text, lexer, parser, startRuleName) {
        var lexResult = lexer.tokenize(text)
        // TODO: expose lexing errors in a better way
//        if (lexResult.errors.length > 1) {
//            throw new Error("sad sad panda, lexing errors detected")
//        }

        parser.reset()
        parser.input = lexResult.tokens
        var value = parser[startRuleName]()
        // TODO: expose parsing errors in a better way
//        if (parser.errors.length > 1) {
//            throw new Error("sad sad panda, parsing errors detected!")
//        }

        return value
    }

    function cleanCache() {
        var hashmaps = _.filter(chevrotain.cache, function (prop) {
            return prop.hasOwnProperty("_state")
        })

        _.forEach(hashmaps, function (cacheMap) {
            cacheMap._state = {}
        })
    }

    function addSvgDiagrams(topRules, useTokenNames) {
        //TODO Use jQuery
        var svgWrapperDiv = document.getElementById("svgWrapperId")
        svgWrapperDiv.innerHTML = ""
        _.forEach(topRules, function (production) {
            document.getElementById("svgWrapperId").innerHTML += convertProductionToDiagram(production, useTokenNames)
        })
    }

    function textAreaChangeHandler() {
        cleanCache()
        var editorFuncVal = eval(editor.getValue())
        var parserConstructor = editorFuncVal.parser
        lexer = editorFuncVal.lexer
        defaultRuleName = editorFuncVal.defaultRule
        var errMsgDiv = $("#errorMessagesDiv")
        errMsgDiv.empty()
        try {
            parser = new parserConstructor()
        } catch (error) {
            errMsgDiv.append($('<h3 class="errorMessage">' + error + '</h3>'))
        }
        var topRules = parser.getGAstProductions().values()
        addSvgDiagrams(topRules, true)
    }

    function checkboxChangeHandler(cb) {
        var state = !cb.checked
        var topRules = parser.getGAstProductions().values()
        addSvgDiagrams(topRules, state)
    }

    $(document).ready(function () {
        var examplesDropdown = $("#example-choice")
        var parserInputExamplesDropdown = $("#parser-input-example-choice")

        //Init the CodeMirror editor
        editor = CodeMirror.fromTextArea(document.getElementById("parserCodeAreaID"), {
            lineNumbers   : true,
            viewportMargin: 35
        })

        //Workaround... I don't know why the text is aligned center by default...
        $(".CodeMirror").css({"text-align": "left", "height": "33rem"})

        //Examples DropDown handling
        function loadExample(exampleName) {
            var sample = samples[exampleName]
            var sampleText = "(" + sample._function.toString() + "())"

            editor.setValue(sampleText)
            textAreaChangeHandler()

            $("#chooseTerminalPrintStyle").attr('checked', false)

            initParserInputExamplesDropDown()
            loadParserInputExample(parserInputExamplesDropdown.val())
        }

        function initExamplesDropDownValues() {
            examplesDropdown.find("option").remove()
            _.forEach(_.sortBy(_.keys(samples)), function (sampleName) {
                examplesDropdown.append("<option>" + sampleName + "</option>")
            })
        }

        initExamplesDropDownValues()

        examplesDropdown.change(function () {
            loadExample(examplesDropdown.val())
        })

        loadExample("calculator")

        //Parser input examples DropDown handling
        function loadParserInputExample(parserInputExampleName) {
            var parserInput = $("#parserInput")
            parserInput.val("")
            parserInput.val(samples[examplesDropdown.val()].exampleInput[parserInputExampleName])
            $("#parserOutput").val("")
            //Simulate a click on the parse button
            parseInputClickHandler()
        }

        function initParserInputExamplesDropDown() {
            parserInputExamplesDropdown.find("option").remove()
            _.forOwn(samples[examplesDropdown.val()].exampleInput, function(exampleValue, exampleName) {
                parserInputExamplesDropdown.append("<option>" + exampleName + "</option>")
            })
        }

        initParserInputExamplesDropDown()

        parserInputExamplesDropdown.change(function () {
            loadParserInputExample(parserInputExamplesDropdown.val())
        })

        $("#refreshSyntaxDiagrams").click(function () {
            console.log("Refreshing the diagrams")
            textAreaChangeHandler()
        })

        function parseInputClickHandler() {
            console.log("Parsing!")
            var parserOutput = $("#parserOutput")
            parserOutput.val("")
            var result = lexAndParse($("#parserInput").val(), lexer, parser, defaultRuleName)
            var processedResult
            if (_.isNumber(result) || _.isString(result) || _.isBoolean(result)) {
                processedResult = result // no processing needed
            }
            else if (_.isObject(result)) {
                processedResult = JSON.stringify(result, null, "\t") // TODO: any better way to display json?
            }
            parserOutput.val(processedResult)
        }

        $("#parseInputBtn").click(parseInputClickHandler)

    })
</script>

</body>
</html>
